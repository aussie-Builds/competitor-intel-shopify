generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)
}

model Shop {
  id                       String       @id @default(uuid())
  shopDomain               String       @unique
  plan                     String       @default("starter")
  planActivatedAt          DateTime?
  alertEmail               String?
  checkIntervalMinutes     Int          @default(360) // User-selected interval, default 6 hours
  maxFrequencyAllowedMinutes Int        @default(360) // Plan gate: lower = more frequent allowed
  lastAutoCheckAt          DateTime?
  hasSeenOnboarding        Boolean      @default(false)
  hasCompletedTour         Boolean      @default(false)
  createdAt                DateTime     @default(now())
  updatedAt                DateTime     @updatedAt
  competitors              Competitor[]
}

model Competitor {
  id         String   @id @default(uuid())
  shopId     String
  shop       Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  name       String
  websiteUrl String
  active     Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  pages      Page[]

  @@index([shopId])
}

model Page {
  id           String     @id @default(uuid())
  competitorId String
  competitor   Competitor @relation(fields: [competitorId], references: [id], onDelete: Cascade)
  url          String
  label        String     @default("Homepage")
  active       Boolean    @default(true)
  lastChecked  DateTime?
  createdAt    DateTime   @default(now())
  snapshots    Snapshot[]
  changes      Change[]

  @@unique([competitorId, url])
  @@index([competitorId])
}

model Snapshot {
  id          String   @id @default(uuid())
  pageId      String
  page        Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)
  contentHash String
  htmlContent String?
  textContent String?
  priceValue  Decimal? @db.Decimal(10, 2)
  priceRaw    String?
  currency    String?
  capturedAt  DateTime @default(now())

  @@index([pageId])
  @@index([capturedAt])
}

model Change {
  id             String   @id @default(uuid())
  pageId         String
  page           Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)
  oldContentHash String?
  newContentHash String
  changeSummary  String?
  aiAnalysis     String?
  significance   String   @default("medium")
  changeType     String?
  oldPrice       Decimal? @db.Decimal(10, 2)
  newPrice       Decimal? @db.Decimal(10, 2)
  priceDelta     Decimal? @db.Decimal(10, 2)
  priceDeltaPct  Float?
  notified       Boolean  @default(false)
  detectedAt     DateTime @default(now())

  @@index([pageId])
  @@index([detectedAt])
  @@index([significance])
  @@index([changeType])
}
